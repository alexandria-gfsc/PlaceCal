env:
  global:
    - CC_TEST_REPORTER_ID=7e0e573cd74e3418226d922174406b38d5692b01d6464701fa57ce51e75eb72a
language: ruby
dist: trusty
addons:
  postgresql: '9.6'
before_script:
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build
  - psql -c 'create database placecal_test;' -U postgres
before_install:
  - |
      if [ "$TRAVIS_BRANCH" = "production" ]; then
        openssl aes-256-cbc -K $encrypted_f4f309cbfdaf_key -iv $encrypted_f4f309cbfdaf_iv -in $TRAVIS_BUILD_DIR/.travis/production-deploy.key.enc -out production-deploy.key -d
      elif [ "$TRAVIS_BRANCH" = "master" ]; then
        openssl aes-256-cbc -K $encrypted_87ceb08cf37e_key -iv $encrypted_87ceb08cf37e_iv -in $TRAVIS_BUILD_DIR/.travis/deploy.key.enc -out deploy.key -d
      fi

deploy:
  skip_cleanup: true
  - provider: script
    script: bash scripts/staging.sh
    on:
      branch: master
  - provider: script
    script: bash scripts/production.sh
    on:
      branch: production
after_script:
  - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT
